<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>NaPiRE trouble predictor: Codes</title>
  <base href="/web/">
  <link rel="shortcut icon" href="./favicon.ico">
  <link rel="stylesheet" href="external/jquery-ui/jquery-ui.css">
  <link rel="stylesheet" href="shared.css">
  <link rel="stylesheet" href="graph.css">
  <script src="external/jquery/jquery.js"></script>
  <script src="external/jquery-ui/jquery-ui.js"></script>
  <script src="external/plotly-latest.min.js" charset="utf-8"></script>
  <script>
    loading = 0;
    function update_loading(inc) {
        loading = loading + inc;
        if(loading < 0) loading = 0;

        if(loading == 0) $("#loading_indicator").hide();
        else $("#loading_indicator").show();
    }

    $( function() {
        const urlParams = new URLSearchParams(window.location.search);
        validation_id = urlParams.get("id");

        $.ajax("/validations?id=" + validation_id).then(function(response) {
            validation_query = response.query;
            $("#description").html(validation_id + ". " + validation_query.inference_method
                        + ": " + validation_query.subsample_size + " subject per subsample, " + validation_query.iterations + " iterations"
                        + (validation_query.merge_subjects ? ", merged" : ""));
            validation_query["inference_method"] = "";
            validation_query["merge_subjects"] = false;

            opts = {
                "method": "POST",
                "contentType": "application/json",
                "processData": false,
                "data": JSON.stringify(validation_query)
            };

            $("#metrics").empty();
            for(let k in response.metrics) {
                let data = response.metrics[k].data;
                let annotation = null;
                let repr = null;
                if(data.length == 0) {
                    repr = "no data";
                } else if(data.length == 1) {
                    if(data[0][0] == null) {
                        repr = JSON.stringify(data[0][1]);
                    }  else {
                        repr = JSON.stringify(data[0][1]);
                        annotation = JSON.stringify(data[0][0]);
                    }
                } else {
                    repr = "<div id=\"plot_" + k + "\"></div>";
                    let traces = Object.keys(data[0][1]).map(dk => {
                        let tr = {
                            "type": "scatter",
                            "name": dk,
                            "x": data.map( xy => xy[0] ),
                            "y": data.map( xy => xy[1][dk] )
                        };

                        if(dk != "value") {
                            tr["yaxis"] = "y2";
                        }
                        return tr;
                    });
                    setTimeout( () => {
                        let layout = {
                            yaxis: { range: response.metrics[k].limits },
                            yaxis2: { overlaying: 'y', side: 'right', rangemode: 'tozero' }
                        };

                        Plotly.newPlot("plot_" + k, traces, layout, { responsive: true });
                    });
                }
                $("#metrics").append("<li>" + k + (annotation == null ? "": " (" + annotation + ") ") + ": " + repr);

            }

            $.ajax("/query?data_url=true", opts).then( function(response) {
                update_loading(-1);
                img = new Image();
                img.src = response;
                $("#output_graph").html(img);
            }).fail( function(response) {
                update_loading(-1);
                $("#output_graph").html(
                    "<p>" + response.statusText + " (" +  response.status + ")<br/>"
                    + response.responseText + "<p>");
            });
        }).fail( function(response) {
            update_loading(-1);
            $("#output_graph").html(
                "<p>" + response.statusText + " (" +  response.status + ")<br/>"
                + response.responseText + "<p>");
        });
        update_loading(+1);

    });
  </script>
</head>
<body>

<p id="description"></p>
<p id="loading_indicator">Loading...</p>

<div id="main">
<div id="output_graph">
</div>

<div>
<ul id="metrics">
</ul>
</div>

</div>

</body>
</html>
