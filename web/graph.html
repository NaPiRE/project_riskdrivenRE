<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>NaPiRE trouble predictor: Results</title>
  <base href="/web/">
  <link rel="shortcut icon" href="./favicon.ico">
  <link rel="stylesheet" href="external/jquery-ui/jquery-ui.css">
  <link rel="stylesheet" href="shared.css">
  <link rel="stylesheet" href="graph.css">
  <script src="external/jquery/jquery.js"></script>
  <script src="external/jquery-ui/jquery-ui.js"></script>
  <script src="external/plotly-latest.min.js" charset="utf-8"></script>
  <script>
    loading = 0;
    function update_loading(inc) {
        loading = loading + inc;
        if(loading < 0) loading = 0;

        if(loading == 0) $("#loading_indicator").hide();
        else $("#loading_indicator").show();
    }

    $( function() {
        const urlParams = new URLSearchParams(window.location.search);
        task_id = urlParams.get("id");
        document.title += " for task " + task_id;

        $.ajax("/tasks?printresult=true&id=" + task_id).then(function(response) {
            query = response.query;

            //$("#task").append("<tr><td></td><td class=\"filter\"></td></tr>");
            $("#task").append("<tr><td>Task number</td><td class=\"filter\">" + response.id + "</td></tr>");
            $("#task").append("<tr><td>Task type</td><td class=\"filter\">" + response.type + "</td></tr>");
            $("#task").append("<tr><td>Task status</td><td class=\"filter\">" + response.state + "</td></tr>");
            if(response.state == "FAILED") {
                $("#task").append("<tr><td>Task error</td><td class=\"filter\">" + response.result +"</td></tr>");
            }
            if(response.state == "RUNNING") {
                $("#task").append("<tr><td>Task completion</td><td class=\"filter\">" + (response.steps_done / response.steps_total * 100).toFixed(2) + "%" +"</td></tr>");
            }
            $("#task").append("<tr><td>Data Set</td><td class=\"filter\">" + response.query.dataset + "</td></tr>");
            $("#task").append("<tr><td>Inference method</td><td class=\"filter\">" + query.inference_method + "</td></tr>");

            query["inference_method"] = "";

            for(let node of query.nodes) {
                $("#node_types").append("<tr><td>" + node[0] + "</td><td class=\"filter\">" + node[1] + "</td><td class=\"filter\">" + node[2] + "</td></tr>");
            }

            for(let conn of query.connect) {
                $("#connections").append("<tr><td>" + conn[0] + "</td><td>" + conn[1] + "</td><td class=\"filter\">" + conn[2] + "</td><td class=\"filter\">" + conn[3] + "</td></tr>");
            }

            function plotQuery() {
                opts = {
                    "method": "POST",
                    "contentType": "application/json",
                    "processData": false,
                    "data": JSON.stringify(query)
                };

                $.ajax("/plot", opts).then( function(response) {
                    update_loading(-1);
                    img = new Image();
                    img.src = response;
                    $("#output_graph").html(img);
                }).fail( function(response) {
                    update_loading(-1);
                    $("#output_graph").html(
                        "<p>" + response.statusText + " (" +  response.status + ")<br/>"
                        + response.responseText + "<p>");
                });
            }

            if(response.type == "TASK_VALIDATION") {
                plotQuery();
                $("#task").append("<tr><td>Subjects per subsample</td><td class=\"filter\">" + query.subsample_size + "</td></tr>");
                $("#task").append("<tr><td>Iterations</td><td class=\"filter\">" + query.iterations + "</td></tr>");

                if(response.state == "DONE") {
                    $("#metrics").show();
                    $("#metrics_list").empty();

                    metrics = [ "napire.Metrics.brier_score", "napire.Metrics.binary_accuracy", "napire.Metrics.recall", "napire.Metrics.precision" ]
                    metrics = metrics.filter(v => response.result[v])
                    other_metrics = Object.getOwnPropertyNames(response.result).filter(v => metrics.indexOf(v) == -1).sort();

                    for(let k of metrics.concat(other_metrics)) {
                        let meta = response.result[k];
                        let result = meta.data;
                        let annotation = null;
                        let repr = null;
                        if(result.length == 0) {
                            repr = "no result";
                        } else if(result.length == 1) {
                            if(result[0][0] == null) {
                                repr = JSON.stringify(result[0][1]);
                            }  else {
                                repr = JSON.stringify(result[0][1]);
                                annotation = JSON.stringify(result[0][0]);
                            }
                        } else {
                            repr = "<div id=\"plot_" + k + "\"></div>";
                            let traces = Object.keys(result[0][1]).map(dk => {
                                let tr = {
                                    "type": "scatter",
                                    "name": dk,
                                    "x": result.map( xy => xy[0] ),
                                    "y": result.map( xy => xy[1][dk] )
                                };

                                if(dk != "value") {
                                    tr["yaxis"] = "y2";
                                }
                                return tr;
                            });
                            setTimeout( () => {
                                let layout = {
                                    xaxis: { title: meta.data_xlabel },
                                    yaxis: { range: meta.limits },
                                    yaxis2: { overlaying: 'y', side: 'right', rangemode: 'tozero' }
                                };

                                Plotly.newPlot("plot_" + k, traces, layout, { responsive: true });
                            });
                        }
                        $("#metrics_list").append("<h2>" + k + (annotation == null ? "": " (" + annotation + ") ") + "</h2><p style=\"text-align: center\">" + repr + "</p>");
                    }
                }
            } else if(response.type == "TASK_INFERENCE") {
                if(response.state == "DONE") {
                    update_loading(-1);
                    img = new Image();
                    img.src = response.result;
                    $("#output_graph").html(img);
                } else {
                    plotQuery();
                }
            }
        }).fail( function(response) {
            update_loading(-1);
            $("#output_graph").html(
                "<p>" + response.statusText + " (" +  response.status + ")<br/>"
                + response.responseText + "<p>");
        });
        update_loading(+1);

    });
  </script>
</head>
<body>

<p id="loading_indicator">Loading...</p>

<div id="main">

<h1>Task settings</h1>

<table>
<thead>
    <th style="width: 55%">Setting</th><th class="filter" style="width: 50%">Value</th>
</thead>
<tbody id="task">
</tbody>
</table>

<div>
<h1>Architecture</h1>
<div id="output_graph">
</div>

<table style="margin-top: 40px">
<thead>
    <th style="width: 60%">Node types</th><th class="filter" style="width: 20%">Weight filter</th><th class="filter" style="width: 20%">Filter</th>
</thead>
<tbody id="node_types">
</tbody>
</table>

<table>
<thead>
    <th style="width: 30%">From</th><th style="width: 30%">To</th><th style="width: 20%">Weight filter</th><th class="filter" style="width: 20%">Filter</th>
</thead>
<tbody id="connections">
</tbody>
</table>
</div>

</div>

<div id="metrics" style="display: none">
<h1>Metrics</h1>
<ul id="metrics_list">
</ul>
</div>

</div>

</body>
</html>
